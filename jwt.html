<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>JWT refresh-rotation + socket.io demo</title>
  <script src="https://cdn.socket.io/4.8.0/socket.io.min.js"></script>
  <style>body{font-family:system-ui; padding:20px; max-width:900px}</style>
</head>
<body>
  <h2>Demo: Access + Refresh Rotation + Socket Auth</h2>

  <div>
    <label>Username: <input id="username" value="alice"></label>
    <label>Password: <input id="password" value="alicepass"></label>
    <button id="btnLogin">Login</button>
    <button id="btnLogout">Logout</button>
  </div>

  <div style="margin-top:12px;">
    <button id="btnMe">Call /me (protected)</button>
    <button id="btnRefresh">Call /refresh (rotate)</button>
    <button id="btnDebug">List server refresh tokens (debug)</button>
  </div>

  <div style="margin-top:12px;">
    <button id="btnConnectSocket">Connect Socket</button>
    <button id="btnDisconnectSocket">Disconnect Socket</button>
    <button id="btnEmitEcho">Emit Echo</button>
  </div>

  <pre id="log" style="background:#111;color:#bfc;padding:12px;height:300px;overflow:auto"></pre>

<script>
  const base = "http://localhost:4000";
  let accessToken = null;
  let socket = null;

  const logEl = document.getElementById("log");
  function log(...args) {
    const s = args.map(a => typeof a === "object" ? JSON.stringify(a,null,2) : String(a)).join(" ");
    logEl.textContent = new Date().toLocaleTimeString() + "  " + s + "\n" + logEl.textContent;
  }

  document.getElementById("btnLogin").onclick = async () => {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const res = await fetch(base + "/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (!res.ok) {
      log("login failed", data);
      return;
    }
    accessToken = data.accessToken;
    log("logged in", data);
  };

  document.getElementById("btnMe").onclick = async () => {
    try {
      const res = await fetch(base + "/me", {
        headers: { Authorization: "Bearer " + (accessToken || "") }
      });
      if (res.status === 401) {
        log("access token expired or invalid. Try refresh first.");
        return;
      }
      const j = await res.json();
      log("/me ->", j);
    } catch (e) {
      log("error calling /me", e);
    }
  };

  document.getElementById("btnRefresh").onclick = async () => {
    // This sends cookie automatically because credentials: 'include'
    const res = await fetch(base + "/refresh", {
      method: "POST",
      credentials: "include"
    });
    const data = await res.json();
    if (!res.ok) {
      log("refresh failed", data);
      accessToken = null;
      return;
    }
    accessToken = data.accessToken;
    log("refresh succeeded, new access token received");
  };

  document.getElementById("btnLogout").onclick = async () => {
    await fetch(base + "/logout", { method: "POST", credentials: "include" });
    accessToken = null;
    log("logged out (refresh cookie cleared server-side)");
    if (socket) { socket.disconnect(); socket = null; log("socket disconnected"); }
  };

  document.getElementById("btnDebug").onclick = async () => {
    try {
      const res = await fetch(base + "/__debug/refresh-tokens");
      const j = await res.json();
      log("server refresh tokens:", j);
    } catch (e) {
      log("debug fetch failed", e);
    }
  };

  // --- socket controls ---
  document.getElementById("btnConnectSocket").onclick = () => {
    if (!accessToken) { log("No access token. Login or refresh to get one."); return; }
    if (socket) { log("Already connected"); return; }

    // pass access token via auth handshake
    socket = io(base, {
      auth: { token: "Bearer " + accessToken },
      withCredentials: true
    });

    socket.on("connect", () => log("socket connected", socket.id));
    socket.on("connect_error", (err) => log("socket connect_error", err && err.message));
    socket.on("welcome", (d) => log("welcome:", d));
    socket.on("echo", (d) => log("echo:", d));
    socket.on("disconnect", (r) => log("socket disconnected:", r));
  };

  document.getElementById("btnDisconnectSocket").onclick = () => {
    if (socket) {
      socket.disconnect();
      socket = null;
      log("socket disconnected by client");
    } else {
      log("no socket connected");
    }
  };

  document.getElementById("btnEmitEcho").onclick = () => {
    if (!socket || !socket.connected) { log("not connected"); return; }
    socket.emit("echo", { time: Date.now(), note: "hello from client" });
  };

  // Auto-refresh on 401 example: if a fetch to /me gets 401, client can call /refresh and retry.
  // For simplification we don't auto-retry here, but manual /refresh button exists.
</script>
</body>
</html>
